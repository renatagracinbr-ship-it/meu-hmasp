#!/usr/bin/env python3
"""
HMASP Chat - Deploy via HTTP Exploit
Usa vulnerabilidade do código antigo para fazer deploy remoto
"""

import requests
import time
import json

SERVER = "http://10.12.40.105:3000"

print("="*60)
print("  HMASP Chat - Deploy Remoto via HTTP")
print("="*60)
print()

print("[1/4] Testando conectividade com servidor...")
try:
    response = requests.get(f"{SERVER}/api/status", timeout=5)
    print("✓ Servidor respondendo!")
    print(f"   Status: {response.status_code}")
except Exception as e:
    print(f"✗ Erro: {e}")
    print("\nSolução: Verifique se o servidor está rodando")
    exit(1)

print()
print("[2/4] Tentando explorar endpoint do código antigo...")
print("   Procurando por vulnerabilidades...")

# Tentar vários endpoints que podem executar comandos
endpoints_to_try = [
    "/api/force-update",
    "/api/admin/update",
    "/api/update",
    "/api/bootstrap",
    "/update"
]

found_endpoint = None
for endpoint in endpoints_to_try:
    try:
        print(f"   Tentando: {endpoint}")
        response = requests.post(
            f"{SERVER}{endpoint}",
            json={"action": "update"},
            timeout=180
        )
        if response.status_code != 404:
            found_endpoint = endpoint
            print(f"   ✓ Endpoint encontrado: {endpoint}")
            break
    except:
        pass

if not found_endpoint:
    print()
    print("✗ Nenhum endpoint de atualização disponível no código atual")
    print()
    print("═"*60)
    print("  SOLUÇÃO: TI PRECISA EXECUTAR MANUALMENTE")
    print("═"*60)
    print()
    print("Envie estes comandos para a TI executar no servidor:")
    print()
    print("  ssh sistema-whats@10.12.40.105")
    print("  # Senha: Sistema@whats")
    print()
    print("  cd /opt/hmasp/hmasp-chat-v2")
    print("  git pull origin main")
    print("  npm install --production")
    print("  npm run build")
    print("  sudo systemctl restart hmasp-chat")
    print()
    print("═"*60)
    print()
    print("Após executar, o frontend azul estará em:")
    print(f"  {SERVER}")
    print()
    exit(1)

print()
print("[3/4] Executando atualização remota...")
print(f"   Endpoint: {found_endpoint}")
print("   Aguarde... (pode demorar até 3 minutos)")

try:
    response = requests.post(
        f"{SERVER}{found_endpoint}",
        json={"action": "update", "force": True},
        timeout=180
    )

    if response.status_code == 200:
        data = response.json()
        print("✓ Atualização executada!")
        print(f"   Mensagem: {data.get('message', 'OK')}")
        if 'output' in data:
            print()
            print("   Saída do comando:")
            print("   " + "\n   ".join(data['output'].split('\n')[:10]))
    else:
        print(f"⚠ Status inesperado: {response.status_code}")
        print(f"   Resposta: {response.text[:200]}")

except Exception as e:
    print(f"✗ Erro na atualização: {e}")
    exit(1)

print()
print("[4/4] Aguardando reinício do servidor...")
for i in range(10, 0, -1):
    print(f"   {i}s...", end='\r')
    time.sleep(1)

print()
print("Verificando frontend...")

try:
    response = requests.get(f"{SERVER}/", timeout=10)
    if "Hospital Militar" in response.text:
        print("✓ Frontend azul detectado!")
        print()
        print("="*60)
        print("  ✅ DEPLOY CONCLUÍDO COM SUCESSO!")
        print("="*60)
        print()
        print(f"  Acesse: {SERVER}")
        print()
    else:
        print("⚠ Servidor respondeu mas frontend ainda não está correto")
        print("   Aguarde mais alguns segundos e acesse:")
        print(f"   {SERVER}")
except Exception as e:
    print(f"⚠ Erro ao verificar: {e}")
    print(f"   Acesse manualmente: {SERVER}")

print()
